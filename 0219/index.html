<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mindful English Coach</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-[#f8fafc] flex items-center justify-center min-h-screen p-4">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const Icon = ({ name, className = "w-5 h-5" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        // --- '골든 문장' 리스트 (3단계 안전장치) ---
        const goldenSentences = [
            {
                type: "Reflective",
                title: "Accumulated Strength",
                text: "The days that seemed unchanged have accumulated, and they have brought me closer to the direction I wanted.",
                translation: "변함없어 보이던 날들이 쌓여 내가 원하던 방향으로 나를 더 가까이 데려다주었습니다."
            },
            {
                type: "Affirmation",
                title: "Consistent Growth",
                text: "Even if I have not reached the person I want to be yet, as long as the direction is not wrong, I believe I will get closer in the end.",
                translation: "아직 되고 싶은 모습에 도달하지 못했더라도, 방향이 틀리지 않는 한 결국 더 가까워질 것입니다."
            },
            {
                type: "Philosophy",
                title: "Living Unseen",
                text: "It is possible to live toward something unseen. Focus more on the time ahead than on the time that has passed.",
                translation: "보이지 않는 것을 향해 나아가는 것은 가능합니다. 지나간 시간보다 앞으로의 시간에 더 집중하세요."
            }
        ];

        const App = () => {
            const [currentTime, setCurrentTime] = useState(new Date());
            const [alarmTime, setAlarmTime] = useState(localStorage.getItem('alarmTime') || '09:00');
            const [isAlarmEnabled, setIsAlarmEnabled] = useState(localStorage.getItem('isAlarmEnabled') === 'true');
            const [selectedContent, setSelectedContent] = useState(goldenSentences[0]);
            const [isPlaying, setIsPlaying] = useState(false);
            const [isCompleted, setIsCompleted] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [activeTab, setActiveTab] = useState('study');
            const [errorMessage, setErrorMessage] = useState(null);

            const apiKey = "AIzaSyDvLaLI9tDJdy8SSlroCfdCmfPWpmd004M"; 

            // --- 알람 체크 및 시계 업데이트 로직 ---
            useEffect(() => {
                const timer = setInterval(() => {
                    const now = new Date();
                    setCurrentTime(now);

                    // 현재 시간을 HH:mm 형식으로 변환
                    const currentHours = String(now.getHours()).padStart(2, '0');
                    const currentMinutes = String(now.getMinutes()).padStart(2, '0');
                    const currentTimeStr = `${currentHours}:${currentMinutes}`;

                    // 알람 조건 체크 (초가 0일 때 한 번만 실행)
                    if (isAlarmEnabled && currentTimeStr === alarmTime && now.getSeconds() === 0) {
                        triggerNotification();
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, [alarmTime, isAlarmEnabled]);

            const triggerNotification = () => {
                if (Notification.permission === "granted") {
                    new Notification("영어 학습 시간입니다! ☀️", {
                        body: "오늘의 긍정적인 문장이 도착했습니다. 소리 내어 읽어보세요.",
                        icon: "https://cdn-icons-png.flaticon.com/512/3256/3256114.png"
                    });
                }
            };

            const toggleAlarm = () => {
                const newState = !isAlarmEnabled;
                setIsAlarmEnabled(newState);
                localStorage.setItem('isAlarmEnabled', String(newState));
                if (newState && Notification.permission !== "granted") {
                    Notification.requestPermission();
                }
            };

            const saveAlarmTime = (time) => {
                setAlarmTime(time);
                localStorage.setItem('alarmTime', time);
            };

            // AI 성공 문장 저장소 (2단계 안전장치)
            const saveToCache = (content) => {
                const cache = JSON.parse(localStorage.getItem('ai_content_cache') || '[]');
                if (!cache.find(c => c.text === content.text)) {
                    cache.push(content);
                    if (cache.length > 30) cache.shift();
                    localStorage.setItem('ai_content_cache', JSON.stringify(cache));
                }
            };

            const getFromFallback = () => {
                const cache = JSON.parse(localStorage.getItem('ai_content_cache') || '[]');
                if (cache.length > 0) {
                    return { ...cache[Math.floor(Math.random() * cache.length)], type: "AI Algorithm (Saved)" };
                }
                return { ...goldenSentences[Math.floor(Math.random() * goldenSentences.length)], type: "Core Wisdom" };
            };

            const fetchAIContent = async () => {
                setIsLoading(true);
                setErrorMessage(null);

                const systemPrompt = `You are a premium English coach. Generate 1-2 inspiring sentences about growth. Return ONLY a JSON object: {"type":"Reflective","title":"...","text":"...","translation":"..."}`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "Generate a new positive English learning card." }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            const fallback = getFromFallback();
                            setSelectedContent(fallback);
                            setErrorMessage("오늘의 AI 한도가 초과되었습니다. 저장된 문장 알고리즘으로 학습을 계속합니다.");
                            setIsLoading(false);
                            return;
                        }
                        throw new Error("AI 연결 오류가 발생했습니다.");
                    }

                    const data = await response.json();
                    const result = JSON.parse(data.candidates[0].content.parts[0].text);
                    
                    setSelectedContent(result);
                    saveToCache(result); 
                    setIsCompleted(false);
                } catch (error) {
                    setSelectedContent(getFromFallback());
                    setErrorMessage("일시적인 오류로 저장된 문장을 불러왔습니다.");
                } finally {
                    setIsLoading(false);
                }
            };

            const handleSpeak = () => {
                if (!selectedContent || isPlaying) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(selectedContent.text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.onstart = () => setIsPlaying(true);
                utterance.onend = () => setIsPlaying(false);
                window.speechSynthesis.speak(utterance);
            };

            return (
                <div className="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-100 flex flex-col h-[750px] animate-fade-in relative">
                    {/* Header */}
                    <div className="bg-indigo-600 p-8 text-white shrink-0 relative overflow-hidden">
                        <div className="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                        <div className="flex justify-between items-center mb-6 relative z-10">
                            <h1 className="text-xl font-bold flex items-center gap-2 tracking-tight">
                                <Icon name="sparkles" className="w-5 h-5 text-yellow-300 fill-yellow-300" />
                                Mindful Premium
                            </h1>
                            <div className="flex bg-white/20 p-1 rounded-xl backdrop-blur-sm">
                                <button onClick={() => setActiveTab('study')} className={`p-2.5 rounded-lg transition-all ${activeTab === 'study' ? 'bg-white text-indigo-600 shadow-md' : 'text-white'}`}>
                                    <Icon name="book-open" />
                                </button>
                                <button onClick={() => setActiveTab('settings')} className={`p-2.5 rounded-lg transition-all ${activeTab === 'settings' ? 'bg-white text-indigo-600 shadow-md' : 'text-white'}`}>
                                    <Icon name="settings" />
                                </button>
                            </div>
                        </div>
                        <div className="flex justify-between items-end relative z-10">
                            <div>
                                <p className="text-indigo-200 text-[10px] font-bold uppercase tracking-widest mb-1">Status: Hybrid Intelligence Mode</p>
                                <p className="text-4xl font-mono font-bold tracking-tighter">
                                    {currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}
                                    <span className="text-xl opacity-40 ml-1">:{currentTime.getSeconds().toString().padStart(2, '0')}</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 p-8 flex flex-col overflow-y-auto">
                        {activeTab === 'study' ? (
                            <div className="flex-1 flex flex-col h-full">
                                <div className="flex-1">
                                    <div className="flex items-center gap-2 mb-4">
                                        <span className="bg-indigo-50 text-indigo-600 text-[10px] font-black px-2.5 py-1 rounded-md uppercase tracking-wider border border-indigo-100">{selectedContent.type}</span>
                                        <h2 className="text-xs font-bold text-slate-400 uppercase tracking-tight truncate">{selectedContent.title}</h2>
                                    </div>
                                    <div className="bg-[#f8fafc] p-7 rounded-[2.5rem] border border-slate-100 min-h-[220px] flex flex-col justify-center mb-6 relative shadow-[inset_0_2px_4px_rgba(0,0,0,0.02)]">
                                        {isLoading && (
                                            <div className="absolute inset-0 bg-white/60 flex items-center justify-center rounded-[2.5rem] z-10 backdrop-blur-[1px]">
                                                <div className="flex flex-col items-center gap-2">
                                                    <Icon name="loader-2" className="animate-spin text-indigo-600 w-8 h-8" />
                                                    <span className="text-[10px] font-bold text-indigo-600 animate-pulse uppercase">Syncing...</span>
                                                </div>
                                            </div>
                                        )}
                                        <p className="text-2xl font-bold text-slate-800 leading-tight mb-6 tracking-tight">"{selectedContent.text}"</p>
                                        <div className="h-px bg-slate-200/60 w-12 mb-4"></div>
                                        <p className="text-[15px] text-slate-500 font-medium leading-relaxed">{selectedContent.translation}</p>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4 mb-6">
                                        <button onClick={handleSpeak} disabled={isLoading} className={`flex flex-col items-center gap-1.5 p-5 rounded-3xl font-bold border transition-all shadow-sm ${isPlaying ? 'bg-indigo-600 text-white' : 'bg-white text-indigo-600 border-indigo-100 active:scale-95'}`}>
                                            <Icon name={isPlaying ? "pause-circle" : "volume-2"} className="w-6 h-6" />
                                            <span className="text-[10px] tracking-widest uppercase font-black">Listen</span>
                                        </button>
                                        <button onClick={() => setIsCompleted(!isCompleted)} className={`flex flex-col items-center gap-1.5 p-5 rounded-3xl font-bold transition-all shadow-sm active:scale-95 ${isCompleted ? 'bg-green-500 text-white' : 'bg-slate-900 text-white'}`}>
                                            <Icon name="check-circle" className="w-6 h-6" />
                                            <span className="text-[10px] tracking-widest uppercase font-black">{isCompleted ? 'Finished' : 'Mark Done'}</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="mt-auto">
                                    {errorMessage && (
                                        <div className="mb-4 p-4 bg-amber-50 text-amber-700 rounded-2xl text-[11px] font-bold border border-amber-100 flex items-start gap-2 animate-fade-in shadow-sm">
                                            <Icon name="alert-circle" className="w-4 h-4 shrink-0 mt-0.5" />
                                            <span>{errorMessage}</span>
                                        </div>
                                    )}
                                    <button onClick={fetchAIContent} disabled={isLoading} className="w-full bg-indigo-600 text-white py-5 rounded-[1.8rem] font-black flex items-center justify-center gap-3 hover:bg-indigo-700 transition-all shadow-xl active:scale-95 disabled:opacity-50">
                                        <Icon name="sparkles" className={`w-5 h-5 ${isLoading ? 'animate-spin' : 'text-yellow-400'}`} />
                                        알고리즘 문장 즉시 생성
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-8 animate-in fade-in h-full">
                                <div>
                                    <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                        <Icon name="bell" className="w-3 h-3" /> 알림 설정 (Daily Reminder)
                                    </h3>
                                    <div className="bg-slate-50 p-6 rounded-[2rem] space-y-6 border border-slate-100 shadow-inner">
                                        <div className="flex justify-between items-center">
                                            <span className="font-bold text-slate-700 text-sm">학습 리마인더 활성화</span>
                                            <button onClick={toggleAlarm} className={`w-14 h-7 rounded-full relative transition-all outline-none ${isAlarmEnabled ? 'bg-indigo-600 shadow-inner' : 'bg-slate-300'}`}>
                                                <div className={`absolute top-1 left-1 bg-white w-5 h-5 rounded-full shadow-md transition-transform ${isAlarmEnabled ? 'translate-x-7' : ''}`}></div>
                                            </button>
                                        </div>
                                        
                                        <div className="flex items-center justify-between pt-5 border-t border-slate-200">
                                            <span className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                                <Icon name="clock" className="w-3 h-3" /> 알람 시간 설정
                                            </span>
                                            <input 
                                                type="time" 
                                                value={alarmTime} 
                                                onChange={(e) => saveAlarmTime(e.target.value)} 
                                                className="bg-white border-2 border-slate-100 rounded-xl px-3 py-1.5 text-sm font-black text-indigo-600 focus:outline-none focus:border-indigo-200 transition-all shadow-sm" 
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Account & Stability</h3>
                                    <div className="bg-slate-50 p-6 rounded-[2rem] space-y-4 border border-slate-100">
                                        <div className="flex justify-between items-center text-sm">
                                            <span className="font-bold text-slate-700">안전 학습 모드</span>
                                            <span className="text-green-600 font-black px-2 py-0.5 bg-green-50 rounded border border-green-100 text-[10px]">ACTIVE</span>
                                        </div>
                                        <p className="text-[11px] text-slate-500 leading-normal">
                                            AI 할당량이 초과되더라도 앱이 멈추지 않습니다. <b>실시간 AI → 저장된 문장 → 골든 문장</b> 순서로 알고리즘이 자동으로 전환되어 끊김 없는 학습을 보장합니다.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="p-6 bg-[#fcfcfd] text-center text-[9px] text-slate-300 border-t border-slate-50 uppercase tracking-[0.3em] font-bold shrink-0">
                        Resilient Wisdom • Gemini 2.5 Strategy
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>